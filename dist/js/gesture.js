function initDom(t){var e=Math.min(800,document.documentElement.clientWidth),n=document.documentElement.clientHeight;canvas.setAttribute("width",e+"px"),canvas.setAttribute("height",.6*n+"px"),canvas.style.className="canvas",initCanvas(t),addEvent()}function initCanvas(t){arr=[],lastPoint=[],restPoint=[],r=ctx.canvas.width/(2+4*t);for(var e=0;e<t;e++)for(var n=0;n<t;n++){var a={x:4*n*r+3*r,y:4*e*r+3*r};arr.push(a),restPoint.push(a)}ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);for(var e=0;e<arr.length;e++)drawCircle(arr[e].x,arr[e].y)}function drawCircle(t,e){ctx.strokeStyle="#FFA500",ctx.lineWidth=2,ctx.beginPath(),ctx.arc(t,e,r,0,2*Math.PI,!0),ctx.closePath(),ctx.stroke()}function drawCurCir(t,e){ctx.fillStyle="#FFA500",ctx.lineWidth=2,ctx.beginPath(),ctx.arc(t,e,r,0,2*Math.PI,!0),ctx.closePath(),ctx.fill()}function drawPoint(t,e){ctx.fillStyle="#FF0000",ctx.beginPath(),ctx.arc(t,e,2,0,2*Math.PI,!0),ctx.closePath(),ctx.fill()}function drawLine(t,e){if(e){ctx.beginPath(),ctx.lineWidth=3,ctx.moveTo(e[0].x,e[0].y);for(var n=0;n<e.length;n++)ctx.lineTo(e[n].x,e[n].y);ctx.lineTo(t.x,t.y),ctx.stroke(),ctx.closePath()}}function getPosition(t){var e=t.currentTarget.getBoundingClientRect();return{x:Math.floor(t.touches[0].clientX-e.left),y:Math.floor(t.touches[0].clientY-e.top)}}function updatePosition(t){ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);for(var e=0;e<arr.length;e++)drawCircle(arr[e].x,arr[e].y);drawPoint(lastPoint),drawLine(t,lastPoint);for(var e=0;e<restPoint.length;e++)if(Math.abs(t.x-restPoint[e].x)<r&&Math.abs(t.y-restPoint[e].y)<r){drawPoint(restPoint[e].x,restPoint[e].y),drawCurCir(restPoint[e].x,restPoint[e].y),lastPoint.push(restPoint[e]),restPoint.splice(e,1);break}}function addEvent(){EventUtil.addHandler(canvas,"touchstart",startHandler),EventUtil.addHandler(canvas,"touchmove",moveHandler),EventUtil.addHandler(canvas,"touchend",endHandler)}function startHandler(t){t=EventUtil.getEvent(t),EventUtil.preventDefault(t);for(var e=getPosition(t),n=0;n<arr.length;n++)if(Math.abs(e.x-arr[n].x)<r&&Math.abs(e.y-arr[n].y)<r){touchFlag=!0,drawPoint(arr[n].x,arr[n].y),drawCurCir(arr[n].x,arr[n].y),lastPoint.push(arr[n]),restPoint.splice(n,1);break}}function moveHandler(t){touchFlag&&(t=EventUtil.getEvent(t),EventUtil.preventDefault(t),updatePosition(getPosition(t)))}function endHandler(t){touchFlag&&(touchFlag=!1,initPwd())}function removeEvent(){EventUtil.removeHandler(canvas,"touchstart",startHandler),EventUtil.removeHandler(canvas,"touchmove",moveHandler),EventUtil.removeHandler(canvas,"touchend",endHandler)}function initPwd(){1==oSetup.checked&&setupPwd(lastPoint),1==oVerify.checked&&verifyPwd(lastPoint)}function setupPwd(t){t.length<4?(oP.innerHTML="密码太短，至少需要5个点",setTimeout(function(){initCanvas(n)},1e3)):checkStorage(t)}function verifyPwd(t){checkPwd(t)?oP.innerHTML="密码正确!":(oP.innerHTML="输入的密码不正确",setTimeout(function(){initCanvas(n)},1e3))}function checkStorage(t){if(window.localStorage.getItem("password"))t||(oP.innerHTML="请输入手势密码"),checkPwd(t)?(oP.innerHTML="密码设置成功",setTimeout(function(){initCanvas(n),oVerify.setAttribute("checked",!0)},1e3)):(oP.innerHTML="两次输入的不一致",window.localStorage.setItem("password",""),setTimeout(function(){initCanvas(n),oP.innerHTML="请重新输入手势密码"},1e3));else{var e=JSON.stringify(t);window.localStorage.setItem("password",e),setTimeout(function(){initCanvas(n),oP.innerHTML="请再次输入手势密码"},1e3)}}function checkPwd(t){var e=JSON.parse(window.localStorage.getItem("password"));if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n].x!=t[n].x||e[n].y!=t[n].y)return!1;return!0}var canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),oP=document.getElementsByTagName("p")[0],oDiv=document.getElementById("choose"),oSetup=oDiv.getElementsByTagName("input")[0],oVerify=oDiv.getElementsByTagName("input")[1];const n=3;window.onload=initDom(n);